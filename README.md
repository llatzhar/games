# Pyxel ターンベースストラテジーゲーム

## 概要
Pyxelライブラリを使用したターンベース戦略ゲームです。プレイヤーと敵AIが交互に行動し、都市間を移動して戦略的な位置取りを行います。

## 機能

### 基本システム
- **ターンベースゲームプレイ**: プレイヤーターンと敵ターンが交互に切り替わる
- **都市ベースマップ**: 6つの都市（Town A～F）が道路で接続された2x3グリッド
- **キャラクター移動**: 接続された都市間のみ移動可能
- **重複防止システム**: 同じ都市に複数キャラクターがいる場合の自動配置調整
- **カメラシステム**: WASDキーでマップを自由に移動

### 敵AIシステム

#### AI行動タイプ
1. **Aggressive AI（アグレッシブ）**
   - **色**: 赤色インジケーター
   - **行動**: 最も近いプレイヤーを積極的に追跡
   - **特徴**: BFSアルゴリズムを使用した最短経路探索
   - **戦略**: プレイヤーに圧力をかけ続ける攻撃的な行動

2. **Patrol AI（パトロール）**
   - **色**: ライトブルーインジケーター
   - **行動**: 事前定義されたルートを循環移動
   - **ルート**: Town F → Town D → Town B → Town E → 繰り返し
   - **特徴**: 予測可能だが一定の脅威を維持

3. **Defensive AI（ディフェンシブ）**
   - **色**: 緑色インジケーター
   - **行動**: プレイヤーから最も遠い場所へ移動
   - **特徴**: 接続された都市の中で最適な逃走先を選択
   - **戦略**: 直接対決を避ける回避行動

4. **Random AI（ランダム）**
   - **色**: ピンクインジケーター
   - **行動**: 接続された都市からランダムに選択
   - **特徴**: 予測不可能な動きで戦略に変化を与える

#### AI視覚システム
- **AIタイプインジケーター**: 各敵の上に小さな色付きの円で行動タイプを表示
- **思考インジケーター**: 敵の決定時間中に点滅する白い円を表示
- **AI凡例**: デバッグ情報内に色と行動タイプの対応表を表示
- **AIタイマー**: 敵ターン中の思考時間をリアルタイム表示

### カメラ追従システム
- **敵ターン中の自動追従**: 敵が選択・移動される際にカメラが自動的に追従
- **スムーズな移動**: カメラは対象キャラクターを中央に捉えながらスムーズに移動
- **手動操作制限**: 敵ターン中の追従時は手動カメラ操作が無効化
- **ターン切り替え時のリセット**: ターンが切り替わる際に追従状態がクリア
- **視覚的フィードバック**: デバッグ情報で追従状態がリアルタイム表示

#### AI技術仕様
- **パスファインディング**: BFS（幅優先探索）アルゴリズムによる最短経路計算
- **決定遅延**: 2秒間（60フレーム）の思考時間でリアルな意思決定を演出
- **ランダム選択**: 複数の敵から公平にランダム選択してターン実行
- **状態管理**: 各AIの内部状態（パトロールインデックス等）を適切に管理

## 操作方法

### 基本操作
- **マウスクリック**: キャラクター選択・移動先指定
- **WASD**: カメラ移動（敵ターン中の追従時は無効）
- **ESC**: 選択解除
- **Space**: ターンスキップ
- **V**: デバッグ情報表示切り替え
- **Q**: タイトル画面に戻る

### カメラ操作
- **プレイヤーターン**: WASDキーで自由にカメラを操作可能
- **敵ターン**: 敵キャラクターに自動的にカメラが追従（手動操作無効）
- **追従解除**: ターン切り替え時に自動的に追従状態がリセット

### ゲームプレイ
1. **プレイヤーターン**: 
   - キャラクターをクリックして選択
   - 接続された都市をクリックして移動
   - 移動完了で自動的に敵ターンに切り替わり

2. **敵ターン**: 
   - AI自動実行（2秒の思考時間後）
   - 敵の行動タイプに応じた戦略的移動
   - 移動完了で自動的にプレイヤーターンに切り替わり

3. **戦闘システム**:
   - 同じ都市にプレイヤーと敵が存在する場合、自動的に戦闘が発生
   - 戦闘結果は即座に計算されるが、アニメーション再生後に実際のHP減少が適用される

## 戦闘再生システム

### 戦闘フェーズ構成
戦闘は以下の5つのフェーズで構成され、各フェーズで異なる状態と表示を行います：

1. **Intro フェーズ（2秒間）**
   - **状態**: 戦闘開始前の状態
   - **表示**: "Battle begins!" メッセージ
   - **HP表示**: 全キャラクターが戦闘前のHPを表示
   - **効果**: 戦闘開始の演出

2. **Player Attack フェーズ（2秒間）**
   - **状態**: プレイヤーの攻撃実行中
   - **表示**: "Players attack for X damage!" メッセージ
   - **HP表示**: 敵のHPが初期値から徐々に減少（アニメーション）
   - **効果**: ダメージ数値が敵側に表示、フラッシュエフェクト

3. **Enemy Attack フェーズ（2秒間）**
   - **状態**: 敵の攻撃実行中
   - **表示**: "Enemies attack for X damage!" メッセージ
   - **HP表示**: プレイヤーのHPが初期値から徐々に減少、敵のHPは減少後の値を維持
   - **効果**: ダメージ数値がプレイヤー側に表示、フラッシュエフェクト

4. **Results フェーズ（3秒間）**
   - **状態**: 戦闘結果の表示
   - **表示**: "Battle concluded" と戦闘前の兵力情報
   - **HP表示**: 全キャラクターが最終的なHP値を表示
   - **効果**: 戦闘サマリーの表示

5. **Outro フェーズ（1秒間）**
   - **状態**: 戦闘終了、フェードアウト
   - **表示**: "Press SPACE or ESC to continue" メッセージ
   - **HP表示**: 最終HP値を維持
   - **効果**: 戦闘シーンの終了準備

### 戦闘メカニクス
- **ダメージ計算**: プレイヤーの総攻撃力 vs 敵の総攻撃力
- **ターゲット選択**: 最も弱い（HP最小）キャラクターを優先攻撃
- **HP適用タイミング**: アニメーション完了後に実際のゲーム状態に反映
- **ユニット削除**: HP0以下のキャラクターは戦闘終了後に削除
- **早期終了**: SPACE/ESCキーで戦闘アニメーションをスキップ可能

### 視覚効果
- **半透明背景**: 戦闘中は背景が暗くなる
- **フラッシュエフェクト**: 攻撃時の視覚的インパクト
- **ダメージナンバー**: 与えたダメージ値が浮かび上がる演出
- **プログレスバー**: 戦闘進行状況を画面下部に表示
- **HP アニメーション**: HP減少が段階的に表示される

## 技術仕様

### 開発環境
- **言語**: Python 3.x
- **ライブラリ**: Pyxel
- **アーキテクチャ**: オブジェクト指向設計（Sceneパターン）

### ファイル構成
- `game.py`: メインゲームエンジンとシーン管理
- `map.py`: マップシーン、キャラクタークラス、AI実装
- `resources.pyxres`: スプライトリソース
- `README.md`: プロジェクトドキュメント

### クラス設計
- `Character`: キャラクターの基底クラス
- `Player`: プレイヤーキャラクター（速度: 2）
- `Enemy`: 敵キャラクター（速度: 1、AI搭載）
- `City`: 都市オブジェクト
- `Road`: 都市間接続
- `MapScene`: メインゲームシーン

### 今後の拡張可能性
- 新しいAI行動タイプの追加
- より複雑なマップレイアウト
- 戦闘システムの強化（スキル、アイテム等）
- マルチプレイヤー対応
- AI学習機能の追加
- 戦闘アニメーションの強化

