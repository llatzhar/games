# 軍人将棋 (Gunjin Shogi) - LAN対戦版

## 概要
LAN内で通信対戦ができる軍人将棋ゲームです。Pygameを使用してグラフィカルなインターフェースを提供し、内蔵サーバー機能により簡単に対戦できます。

## 特徴
- **LAN内での2人対戦**: ホスト/クライアント方式で簡単接続
- **内蔵サーバー機能**: 別途サーバーソフト不要
- **本格的な軍人将棋**: 16種類23個の駒による戦略ゲーム
- **完全隠蔽情報**: 相手の駒の種類は戦闘後も不明
- **リアルタイム同期**: 駒移動とゲーム状態を即座に同期
- **日本語UI**: 完全日本語対応インターフェース

## システム要件
- Python 3.8以上
- pygame 2.0以上
- LAN接続環境
- 日本語フォント（MSゴシック推奨）

## インストール方法
```bash
pip install pygame
```

## ゲームルール

### 盤面
- **変形8×6のマス目** (幅8×高さ6)
- **各プレイヤーは23個の駒**を使用
- **初期配置エリア**: 各プレイヤーの陣地に自由配置
- **戦場エリア**: 中央で駒が交戦

### 駒の種類と数量

**23枚型ルール**

| 駒の種類 | 数量 | 分類 |
|---------|-----|------|
| 大将 | 1 | 将官 |
| 中将 | 1 | 将官 |
| 少将 | 1 | 将官 |
| 大佐 | 1 | 佐官 |
| 中佐 | 1 | 佐官 |
| 少佐 | 1 | 佐官 |
| 大尉 | 2 | 尉官 |
| 中尉 | 2 | 尉官 |
| 少尉 | 2 | 尉官 |
| 飛行機 | 2 | 特殊駒 |
| タンク | 2 | 特殊駒 |
| 騎兵 | 1 | 特殊駒 |
| 工兵 | 2 | 特殊駒 |
| スパイ | 1 | 特殊駒 |
| 地雷 | 2 | 固定駒 |
| 軍旗 | 1 | 固定駒 |

**盤面**: 変形8×6マス

自陣3x8マスと敵陣3x8マス、それをつなぐ通路左から2マス目と右から2マス目
自陣の一番下(敵陣から遠い側)の中央2マスを味方総司令部とする。
同様に敵陣の一番上の中央2マスも敵総司令部である。
総司令部は2つで1マスで、総司令部内における駒は1つ。

### 駒の動かし方

#### 基本駒（将官・佐官・尉官・スパイ）
- **移動範囲**: 前後左右に1マス
- **対象**: 大将、中将、少将、大佐、中佐、少佐、大尉、中尉、少尉、スパイ

#### 特殊な移動を持つ駒

**タンク・騎兵**
- **移動範囲**: 前後左右の1マス、または2マス前
- **制限**: 手前に駒がある場合は飛び越えて2マス前に進むことはできない

**飛行機**
- **移動範囲**: 前後には何マスでも、左右は1マス
- **特殊能力**: 途中の駒を飛び越えられ、突入口を無視してどこからでも敵陣に攻め込める

**工兵**
- **移動範囲**: 前後左右に何マスでも（将棋の飛車と同じ動き）
- **制限**: 途中の駒は飛び越せない

**軍旗・地雷**
- **移動**: 動かせない（固定駒）


### 勝敗表

| 攻撃側＼防御側 | 大将 | 中将 | 少将 | 大佐 | 中佐 | 少佐 | 大尉 | 中尉 | 少尉 | 飛行機 | タンク | 騎兵 | 工兵 | スパイ | 地雷 |
|-------------|-----|-----|-----|-----|-----|-----|-----|-----|-----|-------|-------|-----|-----|-------|-----|
| **大将** | ＝ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | × | ＝ |
| **中将** | × | ＝ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ＝ |
| **少将** | × | × | ＝ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ○ | ＝ |
| **大佐** | × | × | × | ＝ | ○ | ○ | ○ | ○ | ○ | × | × | ○ | ○ | ○ | ＝ |
| **中佐** | × | × | × | × | ＝ | ○ | ○ | ○ | ○ | × | × | ○ | ○ | ○ | ＝ |
| **少佐** | × | × | × | × | × | ＝ | ○ | ○ | ○ | × | × | ○ | ○ | ○ | ＝ |
| **大尉** | × | × | × | × | × | × | ＝ | ○ | ○ | × | × | ○ | ○ | ○ | ＝ |
| **中尉** | × | × | × | × | × | × | × | ＝ | ○ | × | × | ○ | ○ | ○ | ＝ |
| **少尉** | × | × | × | × | × | × | × | × | ＝ | × | × | ○ | ○ | ○ | ＝ |
| **飛行機** | × | × | × | ○ | ○ | ○ | ○ | ○ | ○ | ＝ | ○ | ○ | ○ | ○ | ○ |
| **タンク** | × | × | × | ○ | ○ | ○ | ○ | ○ | ○ | × | ＝ | ○ | × | ○ | ＝ |
| **騎兵** | × | × | × | × | × | × | × | × | × | × | × | ＝ | ○ | ○ | ＝ |
| **工兵** | × | × | × | × | × | × | × | × | × | × | ○ | × | ＝ | ○ | ○ |
| **スパイ** | ○ | × | × | × | × | × | × | × | × | × | × | × | × | ＝ | ＝ |
| **地雷** | ＝ | ＝ | ＝ | ＝ | ＝ | ＝ | ＝ | ＝ | ＝ | × | ＝ | ＝ | × | ＝ | - |

**凡例**: ○=勝利、×=敗北、＝=相討ち


### 戦闘ルール詳細

#### 基本駒の強さ序列
**大将 > 中将 > 少将 > 大佐 > 中佐 > 少佐 > 大尉 > 中尉 > 少尉**

例：少将と中佐が戦うと少将が勝利。将官・佐官は司令部を占領できるため、尉官より価値が高い。

#### 特殊駒の戦闘ルール

**飛行機**
- 将官（大将・中将・少将）にのみ負ける
- その他の全ての駒に勝利

**タンク**
- 将官、飛行機、工兵、地雷に負ける
- その他の駒に勝利

**地雷**
- 飛行機と工兵に負ける
- その他の駒とは相討ち
- 移動不可

**工兵**
- 地雷、スパイ、タンクに勝利
- その他の駒に負ける

**騎兵**
- スパイと工兵にのみ勝利
- その他の駒に負ける

**スパイ**
- 大将にのみ勝利
- その他の駒に負ける（動ける駒の中で最弱）

**軍旗**
- すぐ後ろにある味方の駒と同じ威力を持つ
- 例：軍旗の後ろが少将の場合、軍旗はタンクに勝利
- 例：軍旗の後ろが大佐の場合、軍旗はタンクに負ける
- 軍旗の後ろが地雷の場合、タンクと軍旗は相討ち（地雷は残存）
- 軍旗の後ろが敵駒・空白・最後列の場合、全ての駒に負ける
- 移動不可


### ゲーム内の戦闘システム
- **接触戦闘**: 駒同士が隣接すると自動的に戦闘発生
- **情報隠蔽**: 戦闘後も相手の駒の種類は判明しない
- **結果表示**: 自分の駒の種類と勝敗結果のみ表示
- **戦略要素**: 相手の駒の種類を推理しながら戦う

### ゲーム内の移動システム
- **基本移動**: 将官・佐官・尉官・スパイは前後左右に1マス
- **特殊移動**: タンク・騎兵は1マスまたは2マス前、飛行機は縦横無尽、工兵は直線移動
- **移動制限**: 自分の駒がいるマスには移動不可
- **固定駒**: 軍旗・地雷は移動不可

### 勝利条件

敵の総司令部マスを大将、中将、少将、大佐、中佐、少佐のいずれかの駒で占拠する（これら以外の駒で、相手の総司令部に侵入できたとしても、占拠したことにはならない）か、動かせる駒を全滅させることが目的である。
なお、前記の駒が相手の総司令部に入った時点で占拠したとみなされるので、後からその駒を取ることはできず、ゲーム終了となる。
総司令部が占拠されれば、残った駒の種類や数に関係なくゲームの負けとなる。


### ゲームフロー
1. **駒配置フェーズ**: 各プレイヤーが自陣に駒を配置
2. **配置完了**: 両プレイヤーが配置完了ボタンを押す
3. **ゲーム開始**: プレイヤー1から交互に移動
4. **戦闘発生**: 駒が接触すると自動戦闘
5. **勝利判定**: 勝利条件を満たすまで継続

## 操作方法

### メニュー画面
- **ホストゲーム**: サーバーを立てて相手の接続を待機
- **ゲームに参加**: IPアドレスを入力してホストに接続
- **終了**: ゲーム終了

### 配置フェーズ
- **マウス操作**: 駒をクリックして選択・配置
- **自動配置ボタン**: ランダムに駒を自動配置
- **配置完了ボタン**: 配置を確定して相手を待機

### ゲームプレイ
- **駒選択**: 自分の駒をクリックして選択
- **移動**: 移動可能なマス（緑色表示）をクリック
- **戦闘**: 相手の駒に隣接すると自動戦闘
- **ESCキー**: メニューに戻る

## ネットワークプロトコル

### 基本メッセージ構造
```json
{
    "type": "メッセージタイプ",
    "timestamp": "送信時刻",
    "data": {メッセージデータ}
}
```

### メッセージタイプ一覧

#### 1. 接続メッセージ (connect)
```json
{
    "type": "connect",
    "data": {}
}
```

#### 2. 配置メッセージ (setup)
```json
{
    "type": "setup",
    "data": {
        "player": 1,
        "setup_complete": true,
        "positions": [
            {"x": 0, "y": 6, "type": 1},
            {"x": 1, "y": 6, "type": 2}
        ]
    }
}
```

#### 3. 移動メッセージ (move)
```json
{
    "type": "move",
    "data": {
        "from_x": 0,
        "from_y": 6,
        "to_x": 0,
        "to_y": 5,
        "has_target": false,
        "target_player": 2
    }
}
```

#### 4. 戦闘結果メッセージ (battle_result)
```json
{
    "type": "battle_result",
    "data": {
        "result": "win",
        "position": [0, 5],
        "your_piece_type": 1,
        "your_role": "attacker",
        "opponent_player": 2
    }
}
```

#### 5. ゲーム状態メッセージ (game_state)
```json
{
    "type": "game_state",
    "data": {
        "game_state": "playing"
    }
}
```

### 通信仕様
- **プロトコル**: TCP/IP
- **ポート**: 8888 (デフォルト)
- **エンコーディング**: UTF-8
- **メッセージ形式**: JSON
- **接続タイムアウト**: 30秒

## ファイル構成
```
gunjin/
├── main.py              # エントリーポイント
├── game_client.py       # メインゲームロジック
├── game_board.py        # ゲーム盤面管理
├── pieces.py            # 駒クラス定義
├── network.py           # ネットワーク通信管理
├── ui.py                # ユーザーインターフェース
├── constants.py         # ゲーム定数
├── requirements.txt     # 依存関係
└── README.md            # このファイル
```

## 起動方法
```bash
# ゲーム開始
python main.py

# 操作手順:
# 1. メニューで「ホストゲーム」または「ゲームに参加」を選択
# 2. 駒配置画面で駒を配置
# 3. 「配置完了」ボタンでゲーム開始
# 4. 交互に駒を移動して対戦
```

## 技術仕様

### アーキテクチャ
- **クライアント・サーバーモデル**: 1つのプロセスが両方の役割を担当
- **イベント駆動**: pygameイベントループベース
- **状態管理**: ゲーム状態マシンによる管理
- **スレッド**: ネットワークI/O用の別スレッド

### データ構造
- **盤面**: 8×6の2次元配列
- **駒**: Pieceオブジェクトでカプセル化
- **ゲーム状態**: 列挙型による状態管理
- **メッセージキュー**: スレッド間通信

### セキュリティ考慮事項
- **情報隠蔽**: 相手の駒の種類は送信時点で隠蔽
- **チート対策**: サーバー側での移動妥当性チェック
- **通信暗号化**: 現版では未実装（LAN内前提）

## トラブルシューティング

### 接続エラー
```
問題: "Connection refused" エラー
解決: 
1. ホスト側でファイアウォールを確認
2. ポート8888が開放されているか確認
3. IPアドレスが正しいか確認
```

### ゲーム同期エラー
```
問題: 駒の位置がずれる
解決:
1. 両プレイヤーでゲームを再起動
2. ネットワーク接続を確認
3. ログファイルでエラーをチェック
```

### パフォーマンス問題
```
問題: ゲームが重い
解決:
1. Pythonバージョンを3.8以上に更新
2. pygameを最新版に更新
3. システムリソースを確認
```

## 開発情報

### 今後の拡張予定
- [ ] AI対戦機能
- [ ] リプレイ機能
- [ ] 偵察兵の偵察機能実装
- [ ] 通信暗号化
- [ ] ランキング機能
- [ ] カスタムルール設定

### 既知の制限事項
- 偵察兵の偵察機能は未実装
- 2人以上の対戦は非対応
- リプレイ・観戦機能なし
- チャット機能なし

## ライセンス
MIT License

## 作者
Created with GitHub Copilot

## バージョン履歴
- **v1.0.0**: 初回リリース
  - 基本的なゲーム機能
  - LAN対戦機能
  - 完全隠蔽情報システム
  - リアルタイム同期
